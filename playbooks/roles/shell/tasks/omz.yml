---
- name: Check .path Presence
  stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: omz_home
  tags:
  - omz
  - zsh

# FIXME: figure out how to reuse https://github.com/ctorgalson/ansible-role-oh-my-zsh
- name: Install oh-my-zsh
  shell: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  register: omz_install
  when: not omz_home.stat.exists
  changed_when: omz_install.rc == 0
  tags:
  - omz
  - zsh

- name: Register OMZ plugins
  replace:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: '^plugins=\(.*\)$'
    replace: |
      plugins=(
        git 
        history-substring-search
      )
  tags:
  - omz
  - zsh

- name: Set OMZ 'agnoster' theme
  replace:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: 'ZSH_THEME="robbyrussell"'
    replace: 'ZSH_THEME="agnoster"'
  tags:
  - omz
  - zsh

- name: Check history-search keys bindings
  lineinfile:
    state: absent
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: '^bindkey.*history-substring-search-up$'
  check_mode: true
  changed_when: false
  register: history_search_key_binding
  tags:
  - omz
  - zsh

- name: Bind history-search keys
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: |
      # history-substring-search key bindings    
      bindkey "^[[A" history-substring-search-up
      bindkey "^[[B" history-substring-search-down
    state: present
  when: history_search_key_binding.found == 0
  tags:
  - omz
  - zsh

- name: Check prompt overridden 
  lineinfile:
    state: absent
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: '^prompt_context\(\)\s*\{\s*\}\s*$'
  check_mode: true
  changed_when: false
  register: prompt_override
  tags:
  - omz
  - zsh

- name: Override prompt context
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: |
      # override prompt to remove host name
      prompt_context(){}
    state: present
  when: prompt_override.found == 0
  tags:
  - omz
  - zsh
